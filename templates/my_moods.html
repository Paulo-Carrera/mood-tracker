{% extends "base.html" %}

{% block content %}
<h2>Mood Analysis</h2>

<!-- Charts for Different Time Periods -->
<div>
    <h3>Past Day</h3>
    <canvas id="dayChart" class="mood-chart"></canvas>
</div>
<div>
    <h3>Past Week</h3>
    <canvas id="weekChart" class="mood-chart"></canvas>
</div>
<div>
    <h3>Past Month</h3>
    <canvas id="monthChart" class="mood-chart"></canvas>
</div>
<div>
    <h3>Past Year</h3>
    <canvas id="yearChart" class="mood-chart"></canvas>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const allMoods = JSON.parse('{{ all_moods | tojson | safe }}');

        // Helper function to filter moods by time range
        function filterMoodsByTimeRange(moods, days) {
            const now = new Date();
            return moods.filter(mood => {
                const moodDate = new Date(mood.created_at);
                const timeDiff = (now - moodDate) / (1000 * 60 * 60 * 24); // Time difference in days
                return timeDiff <= days;
            });
        }

        // Helper function to count moods
        function countMoods(moods) {
            return moods.reduce((counts, mood) => {
                counts[mood.mood] = (counts[mood.mood] || 0) + 1;
                return counts;
            }, {});
        }

        // Helper function to render a pie chart
        function renderPieChart(chartId, moodCounts) {
            const labels = Object.keys(moodCounts);
            const data = Object.values(moodCounts);

            const colors = [
                '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', 
                '#9966FF', '#FF9F40', '#6EFF64', '#C9CBCF'
            ];

            new Chart(document.getElementById(chartId), {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors.slice(0, labels.length)
                    }]
                },
                options: {
                    responsive: true, // Make sure the chart resizes on window size changes
                    plugins: {
                        legend: { position: 'bottom' },
                        tooltip: {
                            callbacks: {
                                label: function (tooltipItem) {
                                    const label = tooltipItem.label || '';
                                    const value = tooltipItem.raw || 0;
                                    return `${label}: ${value} times`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Filter moods and render charts for each time range
        const pastDayMoods = filterMoodsByTimeRange(allMoods, 1);
        const pastWeekMoods = filterMoodsByTimeRange(allMoods, 7);
        const pastMonthMoods = filterMoodsByTimeRange(allMoods, 30);
        const pastYearMoods = filterMoodsByTimeRange(allMoods, 365);

        renderPieChart('dayChart', countMoods(pastDayMoods));
        renderPieChart('weekChart', countMoods(pastWeekMoods));
        renderPieChart('monthChart', countMoods(pastMonthMoods));
        renderPieChart('yearChart', countMoods(pastYearMoods));
    });
</script>

<style>
    /* CSS to scale down the charts */
    .mood-chart {
        width: 200px !important; /* Set a fixed width */
        height: 200px !important; /* Set a fixed height */
        max-width: 100% !important; /* Ensure it resizes properly on smaller screens */
        margin: 20px auto; /* Center the charts */
    }
</style>

{% endblock %}
